<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Quản lý thu chi - Số dư & Lịch sử</title>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database-compat.js"></script>
  
  <style>
    body { font-family: system-ui, sans-serif; background: #f0f4f8; margin: 0; padding: 20px; color: #333; }
    .container { max-width: 720px; margin: 0 auto; background: white; padding: 24px; border-radius: 16px; box-shadow: 0 6px 24px rgba(0,0,0,0.1); }
    h1 { text-align: center; color: #2e7d32; margin-bottom: 8px; }
    .balance-box { text-align: center; background: linear-gradient(135deg, #4caf50, #66bb6a); color: white; padding: 28px; border-radius: 12px; margin: 20px 0; font-size: 1.6em; }
    .balance-box small { display: block; font-size: 0.65em; opacity: 0.9; margin-top: 6px; }
    .url-info { text-align: center; font-size: 0.85em; color: #777; margin-bottom: 20px; word-break: break-all; }
    form { display: grid; gap: 16px; }
    label { font-weight: 600; display: block; margin-bottom: 6px; }
    input, select, textarea { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; font-size: 1em; box-sizing: border-box; }
    button { background: #2e7d32; color: white; border: none; padding: 14px; border-radius: 8px; font-size: 1.1em; cursor: pointer; transition: 0.2s; }
    button:hover { background: #1b5e20; }
    .section { margin: 32px 0; }
    .item { background: #f9f9f9; padding: 16px; border-radius: 10px; margin-bottom: 12px; border-left: 5px solid #4caf50; position: relative; }
    .item.thu { border-left-color: #2e7d32; }
    .item.chi { border-left-color: #d32f2f; }
    .item strong { font-size: 1.15em; }
    .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
    .tab { flex: 1; padding: 12px; text-align: center; background: #e0e0e0; border-radius: 8px 8px 0 0; cursor: pointer; font-weight: 600; }
    .tab.active { background: #4caf50; color: white; }
    .hidden { display: none; }
    #loading, #error { text-align: center; padding: 20px; color: #555; font-style: italic; }
    .time { font-size: 0.85em; color: #555; margin-top: 4px; display: block; }
  </style>
</head>
<body>

<div class="container">
  <h1>Quản lý thu chi hàng ngày</h1>
  <div class="url-info">
    Database: <strong>https://khoanchitrongngay-default-rtdb.asia-southeast1.firebasedatabase.app/</strong>
  </div>

  <div class="balance-box">
    Số dư hiện tại: <br>
    <strong id="currentBalance">0 ₫</strong>
    <small>(Tổng thu − Tổng chi)</small>
  </div>

  <div class="tabs">
    <div class="tab active" data-tab="thu">Ghi khoản THU</div>
    <div class="tab" data-tab="chi">Ghi khoản CHI</div>
  </div>

  <!-- Form THU -->
  <form id="incomeForm" class="section">
    <div><label>Ngày</label><input type="date" id="ngay_thu" required></div>
    <div><label>Mô tả khoản thu</label><input type="text" id="mo_ta_thu" placeholder="Lương tháng, thưởng..." required></div>
    <div><label>Số tiền (VNĐ)</label><input type="text" id="so_tien_thu" placeholder="1.500.000" required class="money-input"></div>
    <div><label>Danh mục</label>
      <select id="danh_muc_thu" required>
        <option value="">Chọn danh mục</option>
        <option value="Lương">Lương / Thưởng</option>
        <option value="Trợ cấp">Trợ cấp / Hỗ trợ</option>
        <option value="Kinh doanh">Kinh doanh / Bán hàng</option>
        <option value="Đầu tư">Lãi đầu tư</option>
        <option value="Khác">Khác</option>
      </select>
    </div>
    <div><label>Ghi chú (tùy chọn)</label><textarea id="ghi_chu_thu" rows="2"></textarea></div>
    <button type="submit">Lưu khoản THU</button>
  </form>

  <!-- Form CHI -->
  <form id="expenseForm" class="section hidden">
    <div><label>Ngày</label><input type="date" id="ngay_chi" required></div>
    <div><label>Mô tả khoản chi</label><input type="text" id="mo_ta_chi" placeholder="Ăn trưa, đổ xăng..." required></div>
    <div><label>Số tiền (VNĐ)</label><input type="text" id="so_tien_chi" placeholder="65.000" required class="money-input"></div>
    <div><label>Danh mục</label>
      <select id="danh_muc_chi" required>
        <option value="">Chọn danh mục</option>
        <option value="Ăn uống">Ăn uống</option>
        <option value="Đi lại">Đi lại / Xăng xe</option>
        <option value="Mua sắm">Mua sắm</option>
        <option value="Giải trí">Giải trí</option>
        <option value="Khác">Khác</option>
      </select>
    </div>
    <div><label>Ghi chú (tùy chọn)</label><textarea id="ghi_chu_chi" rows="2"></textarea></div>
    <button type="submit">Lưu khoản CHI</button>
  </form>

  <div id="list" class="section">
    <h3>Danh sách giao dịch gần đây</h3>
    <div id="loading">Đang tải dữ liệu...</div>
    <div id="records"></div>
    <div id="error" style="display:none; color:#d32f2f;"></div>
  </div>
</div>

<script>
// Firebase
const firebaseConfig = { databaseURL: "https://khoanchitrongngay-default-rtdb.asia-southeast1.firebasedatabase.app" };
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const thuRef = db.ref('thu-nhap');
const chiRef = db.ref('chi-tieu');

// Ngày mặc định
const today = new Date().toISOString().slice(0,10);
document.getElementById('ngay_thu').value = today;
document.getElementById('ngay_chi').value = today;

// Tab switch
document.querySelectorAll('.tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    tab.classList.add('active');
    document.getElementById('incomeForm').classList.toggle('hidden', tab.dataset.tab !== 'thu');
    document.getElementById('expenseForm').classList.toggle('hidden', tab.dataset.tab !== 'chi');
  });
});

// Format tiền khi nhập (dấu chấm hàng nghìn)
document.querySelectorAll('.money-input').forEach(input => {
  input.addEventListener('input', e => {
    let val = e.target.value.replace(/\D/g, '');
    if (val) val = Number(val).toLocaleString('vi-VN');
    e.target.value = val;
  });
  input.addEventListener('focus', e => {
    e.target.value = e.target.value.replace(/\./g, '');
  });
  input.addEventListener('blur', e => {
    let val = e.target.value.replace(/\D/g, '');
    if (val) e.target.value = Number(val).toLocaleString('vi-VN');
  });
});

// Submit THU
document.getElementById('incomeForm').addEventListener('submit', e => {
  e.preventDefault();
  const rawMoney = document.getElementById('so_tien_thu').value.replace(/\./g, '');
  const data = {
    ngay: document.getElementById('ngay_thu').value,
    mo_ta: document.getElementById('mo_ta_thu').value.trim(),
    so_tien: Number(rawMoney),
    danh_muc: document.getElementById('danh_muc_thu').value,
    ghi_chu: document.getElementById('ghi_chu_thu').value.trim() || null,
    thoi_gian: firebase.database.ServerValue.TIMESTAMP,
    loai: 'thu'
  };
  thuRef.push(data).then(() => {
    alert('Đã lưu khoản thu!');
    document.getElementById('incomeForm').reset();
    document.getElementById('ngay_thu').value = today;
  }).catch(err => alert('Lỗi: ' + err.message));
});

// Submit CHI (tương tự)
document.getElementById('expenseForm').addEventListener('submit', e => {
  e.preventDefault();
  const rawMoney = document.getElementById('so_tien_chi').value.replace(/\./g, '');
  const data = {
    ngay: document.getElementById('ngay_chi').value,
    mo_ta: document.getElementById('mo_ta_chi').value.trim(),
    so_tien: Number(rawMoney),
    danh_muc: document.getElementById('danh_muc_chi').value,
    ghi_chu: document.getElementById('ghi_chu_chi').value.trim() || null,
    thoi_gian: firebase.database.ServerValue.TIMESTAMP,
    loai: 'chi'
  };
  chiRef.push(data).then(() => {
    alert('Đã lưu khoản chi!');
    document.getElementById('expenseForm').reset();
    document.getElementById('ngay_chi').value = today;
  }).catch(err => alert('Lỗi: ' + err.message));
});

// Format thời gian từ timestamp
function formatDateTime(ts) {
  if (!ts) return '—';
  const date = new Date(ts);
  const d = date.getDate().toString().padStart(2,'0');
  const m = (date.getMonth()+1).toString().padStart(2,'0');
  const y = date.getFullYear();
  const hh = date.getHours().toString().padStart(2,'0');
  const mm = date.getMinutes().toString().padStart(2,'0');
  return `${d}/${m}/${y} ${hh}:${mm}`;
}

// Cập nhật số dư & danh sách (chỉ chạy khi có thay đổi)
let isLoading = true;
function updateUI() {
  const recordsEl = document.getElementById('records');
  recordsEl.innerHTML = '';
  let totalThu = 0, totalChi = 0;
  const allRecords = [];

  Promise.all([
    thuRef.once('value'),
    chiRef.once('value')
  ]).then(([snapThu, snapChi]) => {
    const thuData = snapThu.val() || {};
    Object.entries(thuData).forEach(([id, item]) => {
      totalThu += item.so_tien || 0;
      allRecords.push({ id, ...item });
    });

    const chiData = snapChi.val() || {};
    Object.entries(chiData).forEach(([id, item]) => {
      totalChi += item.so_tien || 0;
      allRecords.push({ id, ...item });
    });

    // Cập nhật số dư
    const soDu = totalThu - totalChi;
    const balanceEl = document.getElementById('currentBalance');
    balanceEl.textContent = soDu.toLocaleString('vi-VN') + ' ₫';
    balanceEl.style.color = soDu >= 0 ? '#2e7d32' : '#d32f2f';

    // Sắp xếp mới nhất → cũ
    allRecords.sort((a,b) => (b.thoi_gian || 0) - (a.thoi_gian || 0));

    // Hiển thị 30 giao dịch gần nhất
    allRecords.slice(0, 30).forEach(item => {
      const div = document.createElement('div');
      div.className = `item ${item.loai}`;
      const sign = item.loai === 'thu' ? '+' : '-';
      const color = item.loai === 'thu' ? '#2e7d32' : '#d32f2f';
      div.innerHTML = `
        <strong style="color:${color}">${sign}${Number(item.so_tien).toLocaleString('vi-VN')} ₫</strong>
        — ${item.mo_ta} <small>(${item.danh_muc || 'Khác'})</small>
        <span class="time">${formatDateTime(item.thoi_gian)} ${item.ghi_chu ? ' • ' + item.ghi_chu : ''}</span>
      `;
      recordsEl.appendChild(div);
    });

    if (allRecords.length === 0) {
      recordsEl.innerHTML = '<p style="text-align:center;color:#777">Chưa có giao dịch nào.</p>';
    }

    document.getElementById('loading').style.display = 'none';
    isLoading = false;
  }).catch(err => {
    document.getElementById('loading').style.display = 'none';
    document.getElementById('error').style.display = 'block';
    document.getElementById('error').textContent = 'Lỗi tải dữ liệu: ' + err.message;
  });
}

// Lắng nghe realtime (chỉ gọi update khi có thay đổi thực sự)
thuRef.on('value', () => { if (!isLoading) updateUI(); });
chiRef.on('value', () => { if (!isLoading) updateUI(); });

// Load lần đầu
updateUI();
</script>
</body>
</html>